name: pipeline

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Use Node.js 12
        uses: actions/setup-node@v1
        with:
          node-version: "12.x"

      - name: Install
        uses: bahmutov/npm-install@v1

      - name: Lint
        run: yarn lint .

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Use Node.js 12
        uses: actions/setup-node@v1
        with:
          node-version: "12.x"

      - name: Install
        uses: bahmutov/npm-install@v1

      - name: Test
        run: yarn test
        env:
          CI: true

      - name: Publish Coverage
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  storybook:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Use Node.js 12
        uses: actions/setup-node@v1
        with:
          node-version: "12.x"

      - name: Install
        uses: bahmutov/npm-install@v1

      - name: "Storybook"
        run: yarn build:storybook

      - name: Publish
        if: github.ref == 'refs/heads/master'
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          BRANCH: gh-pages
          CLEAN: true
          FOLDER: packages/configurator/storybook-static

  release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    needs: [test, lint]

    steps:
      - uses: actions/checkout@v1

      - name: Use Node.js 12
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Install
        uses: bahmutov/npm-install@v1

      - name: Build configurator
        if: "!startsWith(github.ref, 'refs/tags/@betaflight/configurator@')"
        run: yarn build

      - name: Release configurator
        if: startsWith(github.ref, 'refs/tags/@betaflight/configurator@')
        run: yarn release
        env:
          GH_TOKEN: ${{ secrets.github_token }}
          
      - name: Output Linux
        uses: actions/upload-artifact@v2-preview
        with:
          name: linux
          path: packages/configurator/dist/*.snap

      - name: Output Windows
        uses: actions/upload-artifact@v2-preview
        with:
          name: windows
          path: packages/configurator/dist/*.msi

      - name: Output MacOS
        uses: actions/upload-artifact@v2-preview
        with:
          name: macos
          path: |
            packages/configurator/dist/*.dmg

